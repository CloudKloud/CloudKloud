{% load static %}


<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Language" content="en">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Analytics Dashboard - This is an example dashboard created using build-in elements and components.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no" />
    <meta name="description" content="This is an example dashboard created using build-in elements and components.">
    <meta name="msapplication-tap-highlight" content="no">
    <!--
    =========================================================
    * ArchitectUI HTML Theme Dashboard - v1.0.0
    =========================================================
    * Product Page: https://dashboardpack.com
    * Copyright 2019 DashboardPack (https://dashboardpack.com)
    * Licensed under MIT (https://github.com/DashboardPack/architectui-html-theme-free/blob/master/LICENSE)
    =========================================================
    * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
    -->
<link href="{% static 'css/main.css' %}" rel="stylesheet">
<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<link href="https://unpkg.com/jquery-resizable-columns@0.2.3/dist/jquery.resizableColumns.css" rel="stylesheet">
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>




<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.0/dist/bootstrap-table.min.css">
  

    <link rel="stylesheet" href="https://uicdn.toast.com/tui.chart/latest/tui-chart.min.css">
    <script type='text/javascript' src='https://uicdn.toast.com/tui.code-snippet/v1.5.0/tui-code-snippet.min.js'></script>
    <script type='text/javascript' src='https://uicdn.toast.com/tui.chart/latest/raphael.js'></script>
    <script src="https://uicdn.toast.com/tui.chart/latest/tui-chart.min.js"></script>

    <style>
        .select,
        
        .like {
          margin-right: 10px;
        }

        td {
            overflow : hidden;
            text-overflow:ellipsis;
            white-space : nowrap;
        }
      </style>
</head>

<body>
    <div class="app-container app-theme-white body-tabs-shadow fixed-sidebar fixed-header">
        
        
        
        
        <div class="app-header header-shadow" class="hi">  <!-- 창 위쪽 헤더부분 div -->
            
            
            <!--  로고 -->
            <div class="app-header__logo">
                <div class="logo-src"></div>
                <div class="header__pane ml-auto">
                    <div>
                        <button type="button" class="hamburger close-sidebar-btn hamburger--elastic" data-class="closed-sidebar">
                            <span class="hamburger-box">
                                <span class="hamburger-inner"></span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            

            
            <!-- 헤더 콘텐츠 -->
            <div class="app-header__content">
                
                
                

                <div class="app-header-right">
                    <div class="header-btn-lg pr-0">
                        <div class="widget-content p-0">
                            <div class="widget-content-wrapper">
                                <div class="widget-content-left">
                                    <div class="btn-group">
                                        <a data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="p-0 btn">
                                            <img width="42" class="rounded-circle" src="assets/images/avatars/1.jpg" alt="">
                                            <i class="fa fa-angle-down ml-2 opacity-8"></i>
                                        </a>
                                        <div tabindex="-1" role="menu" aria-hidden="true" class="dropdown-menu dropdown-menu-right">
                                            <button type="button" tabindex="0" class="dropdown-item">User Account</button>
                                            <button type="button" tabindex="0" class="dropdown-item">Settings</button>
                                            <h6 tabindex="-1" class="dropdown-header">Header</h6>
                                            <button type="button" tabindex="0" class="dropdown-item">Actions</button>
                                            <div tabindex="-1" class="dropdown-divider"></div>
                                            <button type="button" tabindex="0" class="dropdown-item">Dividers</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="widget-content-left  ml-3 header-user-info">
                                    <div class="widget-heading">
                                        Gunha Jang
                                    </div>
                                    <div class="widget-subheading">
                                        BOB digital forensic track
                                    </div>
                                </div>
                                <div class="widget-content-right header-user-info ml-3">
                                    <button type="button" class="btn-shadow p-1 btn btn-primary btn-sm show-toastr-example">
                                        <i class="fa text-white fa-calendar pr-1 pl-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>        
                </div>
            </div> 
        </div>
        

        
        
        <!-- 메인 화면 -->
        <div class="app-main">

                <!-- sidebar -->
                <div class="app-sidebar sidebar-shadow">
                    <div class="app-header__logo">
                        <div class="logo-src"></div>
                        <div class="header__pane ml-auto">
                            <div>
                                <button type="button" class="hamburger close-sidebar-btn hamburger--elastic" data-class="closed-sidebar">
                                    <span class="hamburger-box">
                                        <span class="hamburger-inner"></span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="app-header__mobile-menu">
                        <div>
                            <button type="button" class="hamburger hamburger--elastic mobile-toggle-nav">
                                <span class="hamburger-box">
                                    <span class="hamburger-inner"></span>
                                </span>
                            </button>
                        </div>
                    </div>
                    <div class="app-header__menu">
                        <span>
                            <button type="button" class="btn-icon btn-icon-only btn btn-primary btn-sm mobile-toggle-header-nav">
                                <span class="btn-icon-wrapper">
                                    <i class="fa fa-ellipsis-v fa-w-6"></i>
                                </span>
                            </button>
                        </span>
                    </div>    <div class="scrollbar-sidebar">
                        <div class="app-sidebar__inner">
                            <ul class="vertical-nav-menu">
                                <li class="app-sidebar__heading">Home</li>
                                <li>
                                    <a href="/" >
                                        <i class="metismenu-icon pe-7s-cloud"></i>
                                        Main Page
                                    </a>
                                </li>
                                <li class="app-sidebar__heading">Logs</li>
                                <li>
                                    <a href="/logs" >
                                        <i class="metismenu-icon pe-7s-look"></i>
                                        Log Explorer

                                    </a>
                                    <a href="/query" class="mm-active">
                                        <i class="metismenu-icon pe-7s-display1"></i>
                                        Threat Items
                                    </a>
                                    <a href="/baguni">
                                        <i class="metismenu-icon pe-7s-date"></i>
                                        Log Baguni
                                    </a>

                                </li>
                                <li class="app-sidebar__heading">Settings</li>
                                <li>
                                    <a href="/regist">
                                        <i class="metismenu-icon pe-7s-add-user"></i>
                                        Registeration
                                    </a>
                                    <a href="/check">
                                        <i class="metismenu-icon pe-7s-check"></i>
                                        Settings Check
                                    </a>
                                </li>
                                
                                 
                            </ul>
                        </div>
                    </div>
                </div>    
                
                
                
                
                


                <!-- 화면에 보이는 부분 -->

                <div class="app-main__outer">
                
                    
                    <div class="app-main__inner">
                        
                        
                        <!-- 페이지 헤더 부분 -->
                        <div class="app-page-title">
                            <div class="page-title-wrapper">
                                <div class="page-title-heading">
                                    <div class="page-title-icon">
                                        <i class="pe-7s-display1 icon-gradient bg-mean-fruit">
                                        </i>
                                    </div>
                                    <div>Threat Items
                                        <div class="page-title-subheading">Dive into essential Logs easily!
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>     
                        
                        

                        
                        <!-- CUSTOM PART -->
                         <!-- google chart 의 표 쓰기 -->
                         <div class="row">
                            <div class="col-md-12">
                                
                                
                                    <div class="col-lg-12">
                                        <div class="main-card mb-3 card" style="width : 100%;">
                                            <div class="card-body">

                                                <div id="threatitemtitle" class="app-sidebar__heading" style="font-size: 25px;"></div>

                                                <div class="row" style="margin-bottom : 10px;" >
                                                    <div id="chart-area2" style="margin: 0 auto;"></div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <div id="chart-area" style="float:left;" ></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <div id="chart-area3" style="float: right;"></div>
                                                        </div>
                                                    </div>

                                                </div>
                                              
                                         
                                                
                                                <!-- loader -->
                                                <div id = "loader" class="spinner-border text-primary"></div><br>
                                         
                                                <button id="remove" class="btn btn-danger" disabled>Log Baguni</button>
                                     
                                                <table 
                                                    id="table"
                                                    data-toggle="table"

                                                    data-detail-view="true"
                                                    data-detail-view-icon="true"
                                                    data-detail-formatter="detailFormatter"

                                                    data-row-attributes="rowAttributes"
                                        
                                                    data-search="true"
                                                    
                                                    data-show-search-button="true"

                                                    data-id-field="id"
                                          
                                                    data-click-to-select="true"

                                                    data-toolbar="#remove"
                                                    data-buttons = "buttons"
                                                    data-resizable="true"                                                 
                                                    data-pagination="true"
                                                    pageSize="10"
                                                    style = "table-layout: fixed;"
                                                >   
                                                    <thead>
                                                      <tr>
                                                        <th data-field="state" data-checkbox="true" data-width="50" data-width-unit="px"> </th>
                                                        <th data-field="id" data-width = "50" >ID</th>
                                                        <th data-field="timestamp" data-width = "170">timestamp</th>
                                                        
                                                        <th data-field="message">message</th>
                                                    
                                                        <th data-field="user" >user</th>
                                                        <th data-field="ip" data-width = "140">IP</th>
                                                        <th data-field="eventName" >Event Name</th>
                                                        
                                                        <th data-field="target" >Target</th>
                                                        <th data-field="param" >Parameters</th>
                                                        
                                                      </tr>
                                                    </thead>
                                                  </table>
                                             
                                                
                                            </div>
                                        </div>
                                    </div>

                                    
                                
                            </div>
                        </div>

                </div>
                
        </div>
    </div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/bootstrap-table@1.18.0/dist/bootstrap-table.min.js"></script>
<script type="text/javascript" src="{% static 'js/main.js' %}"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
<script src="https://unpkg.com/jquery-resizable-columns@0.2.3/dist/jquery.resizableColumns.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.1/dist/extensions/resizable/bootstrap-table-resizable.min.js"></script>

<script>
    
    
    window.onload = function(){

        let num = ('{{ id }}')
        let threatitem = [['S3','버킷 목록 검색', 'description'], ['S3', 'S3 데이터 생성', 'description'], ['S3', 'S3 데이터 삭제', 'description'], ['S3', '권한이 없는 IAM 개체의 S3 API 호출', 'description'], ['S3', '서버 액세스 로깅 비활성화', 'description'], ['S3', '버킷 또는 객체 권한 변경', 'description'], ['S3', '버킷 정책 변경', 'description'], ['S3','침투 테스트 시스템에서 API 호출(kali, parrot, pentoo...)', 'description'], 
                          ['IAM','침투 테스트 시스템에서 API 호출(kali, parrot, pentoo...)','description'], ['IAM','네트워크 액세스 권한 변경'], ['IAM','CloudTrail 로깅 중단, 기존 로그 삭제'],['IAM','IAM 사용자, 그룹, 정책 등 추가/변경/삭제'],['IAM','리소스 보안 액세스 정책 변경'],['IAM','루트 계정으로 API 호출'],['IAM','컴퓨팅 리소스 시작'],
                          ['RDS','DB 목록 검색'],['RDS','DB 내의 데이터 삭제'], ['RDS','DB 사용자 추가'], ['RDS','DB 사용자 권한 변경'], ['RDS','권한이 없는 IAM 개체의 RDS API 호출'], ['RDS','RDS 로깅 비활성화(파라미터 그룹 수정)'], ['RDS','RDS 로깅 비활성화(파라미터 그룹 삭제)'], ['RDS','DB 중지'], ['RDS','DB 삭제'], ['RDS','침투 테스트 시스템에서 API 호출(kali, parrot, pentoo...)'], ['RDS','RDS 로깅 비활성화(CloudWatch 로깅 수정)'], ['RDS','DB 연결 실패'], 
                          ['EC2','쉘 명령어 사용 (yum)'], ['EC2','쉘 명령어 사용 (sudo)'], ['EC2','쉘 명령어 사용 (service)'], ['EC2','쉘 명령어 사용 (cron)'], [],['EC2','인스턴스 생성, 실행'], ['EC2','인스턴스 중지, 삭제'], ['EC2','보안그룹 수정'], ['EC2','침투 테스트 시스템에서 API 호출(kali, parrot, pentoo...)']];
    
        url = "https://threatitem.s3.ap-northeast-2.amazonaws.com/" + threatitem[num][0] + "/" + num;
        //$('table').attr('data-url', url);
        $('#threatitemtitle').html(threatitem[num][1]);

        
        
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() { // 요청에 대한 콜백
        $("#loader").show();
        if (xhr.readyState === xhr.DONE) { // 요청이 완료되면
            if (xhr.status === 200 || xhr.status === 201) {
                $("#loader").hide();
                let $table = $('#table');
                let $remove = $('#remove');
                
                let original_data = JSON.parse(xhr.responseText)['rows'];
                console.log(original_data);
            
                

                if(original_data.length != 0 && original_data[0].message[0]=='{'){
                    //테이블 그리기

                    let initial_data = JSON.parse(xhr.responseText)['rows'];
                    initial_data = get_important_data(initial_data, num);

                    console.log(initial_data);

                    if(initial_data == 0){
                        $(function(){
                        $table.bootstrapTable('destroy');
                        $table.bootstrapTable({data:original_data});
                        $table.bootstrapTable('hideColumn', 'message');
                    })
                    }else{
                        $(function(){
                        $table.bootstrapTable('destroy');
                        $table.bootstrapTable({data:initial_data});
                        $table.bootstrapTable('hideColumn', 'message');
                    })
                    }
                
                    //$table.bootstrapTable({data:original_data});


                    // advanced search
                    let advanced_search_options = [];
                    let row_keys = JSON.parse(xhr.responseText)['rows'];
                    console.log(row_keys);
                    let parsed_data = get_advanced_search_selectkeys(row_keys);
            
                    advanced_search_options = ['awsRegion', 'eventName', 'eventSource', 'eventType', 'sourceIPAddress', 'type', 'userName']; // arn, sourceIPAddress => custom input
                    console.log(advanced_search_options);

                    for (let i=0;i<advanced_search_options.length;i++){
                        if(i == 4){
                            let option = "<div id= 'optionname" + i+"'>" +advanced_search_options[i]+"</div><input type='text' class='form-control' id='optioninput" + i + "'>";
                        
                            $('#myModal-body').append(option);
                        } else{
                            let option = "<div id= 'optionname" + i+"'>" + advanced_search_options[i] +"</div><select class='form-control' id='optioninput" + i + "'>";
                            let tmp = parsed_data[i];
                            for(let j=0;j<tmp.length;j++){
                                option = option + "<option>" + tmp[j] + "</option>";
                            }
                            option = option + "</select>";
                            $('#myModal-body').append(option);
                        }

                    }


                    // 라인차트 전처리

                    let timelinedata = JSON.parse(xhr.responseText)['rows'];


                    let chartdata = timeline_graph_data(timelinedata);
                    console.log(chartdata);


                    var container2 = document.getElementById('chart-area2');
                    var options2 = {
                        chart: {
                            width: 1160,
                            height: 540,
                            title: 'Generated Logs per Time'
                        },
                        yAxis: {
                            title: 'Logs (number)'
                        },
                        xAxis: {
                            title: 'Day',
                            pointOnColumn: true,
                        
                            tickInterval: 'auto'
                        },
                        series: {
                            showDot: false,
                            zoomable: true,
                            allowSelect : true
                        },
                    };
                

                    let chart2 = tui.chart.lineChart(container2, chartdata, options2);


                    // 파이차트 (iam user 전처리)
                    var options = {
                        chart: {
                            width: 700,
                            
                            title: 'IPs related to this item'
                        },
                        tooltip: {
                            suffix: '%'
                        },
                    
                    };
                    let options_for_iam = {
                        chart: {
                            width: 700,
                            
                            title: 'IAM Users related to this item'
                        },
                        tooltip: {
                            suffix: '%'
                        },
                    
                    };
                    var theme = {
                        series: {
                            colors: [
                                '#83b14e', '#458a3f', '#295ba0', '#2a4175', '#289399',
                                '#289399', '#617178', '#8a9a9a', '#516f7d', '#dddddd'
                            ]
                        }
                    };
                    let iam_data = JSON.parse(xhr.responseText)['rows'];
                
                    let iam_data_rep = pie_graph_iam_data(iam_data);

                    let container3 = document.getElementById('chart-area3');

                    let pieiamchart = tui.chart.pieChart(container3, iam_data_rep, options_for_iam);
                    pieiamchart.on('selectSeries', function(info){

                        location.href = "http://localhost:8000/iamkey/"+info.legend;
                        //more(info.legend);
                    });
                
                    pieiamchart.on('changeCheckedLegends', function(info){
                        $("#loader").show();
                        let checkedLegends = info.pie;
                    

                        let unchecked_iam = [];
                        for(let i=0;i<checkedLegends.length;i++){
                            if(checkedLegends[i] != true){
                                unchecked_iam.push(iam_data_rep.series[i]['name']);
                            }
                        }

                        let responsive_data = JSON.parse(xhr.responseText)['rows'];
                        console.log(unchecked_iam);


                        let filtered_data = responsive_data.filter(function(n){
                            return !((unchecked_iam.includes(JSON.parse(n.message).userIdentity.type)) || (unchecked_iam.includes(JSON.parse(n.message).userIdentity.userName)));
                        })
                        let changed_table_data= responsive_data.filter(function(n){
                            return !((unchecked_iam.includes(JSON.parse(n.message).userIdentity.type)) || (unchecked_iam.includes(JSON.parse(n.message).userIdentity.userName)));
                        })

                        console.log(changed_table_data);
                        filtered_data = timeline_graph_data(filtered_data);

                        $("#loader").hide();
                        chart2.destroy();
                        chart2 = tui.chart.lineChart(container2, filtered_data, options2);

                        let changed_table_data_important = get_important_data(changed_table_data, num);

                        $(function(){
                            $table.bootstrapTable('destroy');
                            $table.bootstrapTable({data:changed_table_data_important});
                        });




                    });


                    // 파이차트 전처리
                    var data = JSON.parse(xhr.responseText)['rows'];


                    let result = pie_graph_data(data);

                    var container = document.getElementById('chart-area');

                
                    // For apply theme
                
                    // tui.chart.registerTheme('myTheme', theme);
                    // options.theme = 'myTheme';
                
                    var piechart = tui.chart.pieChart(container, result, options);
                    piechart.on('selectSeries', function(info){

                        location.href = "http://localhost:8000/ip/"+info.legend;
                        //more(info.legend);
                    });

                    piechart.on('changeCheckedLegends', function(info){
                        $("#loader").show();
                        let checkedLegends = info.pie;
                        console.log(info);
                        console.log(result);
                        let unchecked_ip = [];
                        for(let i=0;i<checkedLegends.length;i++){
                            if(checkedLegends[i] != true){
                                unchecked_ip.push(result.series[i]['name']);
                            }
                        }
                        console.log(unchecked_ip);
                        let responsive_data = JSON.parse(xhr.responseText)['rows'];

                        let filtered_data = responsive_data.filter(function(n){
                            return !(unchecked_ip.includes(JSON.parse(n.message).sourceIPAddress))
                        })
                        let changed_table_data= responsive_data.filter(function(n){
                            return !(unchecked_ip.includes(JSON.parse(n.message).sourceIPAddress))
                        })

                        console.log(changed_table_data);
                        filtered_data = timeline_graph_data(filtered_data);

                        $("#loader").hide();
                        chart2.destroy();
                        chart2 = tui.chart.lineChart(container2, filtered_data, options2);

                        let changed_table_data_important = get_important_data(changed_table_data, num);

                        $(function(){
                            $table.bootstrapTable('destroy');
                            $table.bootstrapTable({data:changed_table_data_important});
                        });




                    });
                }
                else if(original_data.length==0){
                    alert('관련 로그가 존재하지 않습니다');

                }
                else if(original_data[0].message[0]!='{'){
                    let initial_data = JSON.parse(xhr.responseText)['rows'];
                    initial_data = get_important_data(initial_data, num);

                    console.log(initial_data);

                    $(function(){
                        $table.bootstrapTable('destroy');
                        $table.bootstrapTable({data:initial_data});
                        $table.bootstrapTable('hideColumn','user');
                        $table.bootstrapTable('hideColumn','ip');
                        $table.bootstrapTable('hideColumn','eventName');
                        $table.bootstrapTable('hideColumn','target');
                        $table.bootstrapTable('hideColumn','param');
                    })

                    let timelinedata = JSON.parse(xhr.responseText)['rows'];


                    let chartdata = timeline_graph_data(timelinedata);
                    console.log(chartdata);

                    let container2 = document.getElementById('chart-area2');
                    let options2 = {
                        chart: {
                            width: 1160,
                            height: 540,
                            title: 'Generated Logs per Time'
                        },
                        yAxis: {
                            title: 'Logs (number)'
                        },
                        xAxis: {
                            title: 'Day',
                            pointOnColumn: true,
                        
                            tickInterval: 'auto'
                        },
                        series: {
                            showDot: false,
                            zoomable: true,
                            allowSelect : true
                        },
                    };
                

                    let chart2 = tui.chart.lineChart(container2, chartdata, options2);
                }
                else{
                    alert('알 수 없는 에러!');
                }
                

                
                
            } else {
                console.error(xhr.responseText);
            }
        }
    };
    xhr.open('get', url); // 메소드와 주소 설정

    xhr.send(); // 요청 전송 
        
    }

function detailFormatter(index, row) {
    let num = ('{{ id }}');
    if(num==16 || num==17 || num==18 || num==26 || num==27 || num==28 || num==29 || num ==30){
        let html = []
        $.each(row, function (key, value) {
          if(key == 'id' || key=='timestamp' || key=='message')
          html.push('<p><b>' + key + ':</b> ' + value + '</p>')
        })
        return html.join('')
    }
    else{
        var html = []
        let re = /"type"|"userName"|"eventName"|"eventSource"|"awsRegion"|"sourceIPAddress"|"requestParameters"/g;
        function replacer(match){
            return "<b><mark>"+match+"</mark></b>"
        }
        $.each(row, function (key, value) {
            if(key == 'message'){

                let regex_before = JSON.stringify(JSON.parse(value),null,4);
                let regex_after = regex_before.replace(re, replacer);

                html.push('<p><pre><code class="json">' +regex_after + '</code></pre></p>');
            }


          //html.push('<p><b>' + key + ':</b> ' + value + '</p>')
        })

        return html.join('');
    }
    

};

  

  $(function() {
    let $table = $('#table');
    let $remove = $('#remove');
    $table.on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table', function () {
      $remove.prop('disabled', !$table.bootstrapTable('getSelections').length)
    })
  
    $remove.click(function () {
      
        var tag = prompt("태그를 입력해주세요"+"");
        

      $.map($table.bootstrapTable('getSelections'), function (row) {
        $.ajax({
        type: "POST",
        url: "/logbaguni",
        dataType: "json",
        data: {
            'timestamp': row.timestamp,
            'tag' : tag,
            'content': row.message,
            'csrfmiddlewaretoken': '{{csrf_token}}',
        },
        success: function (response) {
            alert('OK');
        },
        error: function (error) {
            alert('OK');
        },
        });
      })
      
      
      $remove.prop('disabled', true)
    })
    
   
  })

    function buttons () {
      return {
        btnUsersAdd: {
            text: 'Highlight Users',
            icon: 'fa-sync',
            event: function () {
                window.location.reload();
            },
            attributes: {
              title: 'Search all users which has logged in the last week'
            }
        },
        btnAdd: {
          text: 'Add new row',
          icon: 'fa-search-plus',
          event: function () {
            $('#myModal').modal();
            
          },
          attributes: {
            title: 'Add a new row to the table'
          }
        },
        btnColumn:{
          text: 'Add new row',
          icon: 'fa-filter',
          event: function () {
            $('#myModal2').modal();
            
          },
          attributes: {
            title: 'Add a new row to the table'
          } 
        }
      }
    }

    function modal_apply_click(){
        let $table = $('#table');
        
        let advanced_search_list = [];
        for(let i=0;i<7;i++){
            let tagtitle = 'optionname' + i;
            let tagtitlevalue = document.getElementById(tagtitle).innerHTML;
            let tagname = 'optioninput'+i;
            let tagnamevalue = document.getElementById(tagname).value;
            console.log(tagnamevalue);
            if(tagnamevalue == "" || tagnamevalue=="default"){

            }
            else{
                advanced_search_list.push([tagtitlevalue, tagnamevalue]);
            }
            
            
        }
        
        console.log(advanced_search_list);
        let advanced_search_before = $table.bootstrapTable('getData');
        for(let i=0;i<advanced_search_before.length;i++){
            let msg = JSON.parse(advanced_search_before[i].message);
            
           
            for(let j=0;j<advanced_search_list.length;j++){
                let prop = advanced_search_list[j][0];
                let val = advanced_search_list[j][1];

                if(prop=='awsRegion' || prop == 'eventName' || prop == 'eventSource' || prop == 'eventType' || prop == 'sourceIPAddress'){
                    if(msg[prop]!=val){
                        advanced_search_before[i].message = "";
                    }
                }
             
                else if(prop == 'arn' || prop == 'type' || prop == 'userName'){
                    if(msg.userIdentity[prop]!=val){
                        advanced_search_before[i].message = "";
                    }
                }
            }
           
        }
        console.log(advanced_search_before);
   
        let advanced_search_after = advanced_search_before.filter(function(n){
            return n.message != "";
        });
        
        $(function(){
            $table.bootstrapTable('destroy');
            $table.bootstrapTable({data:advanced_search_after});
        })

  
        
    }
 
    function modal2_apply_click(){
        let $table = $('#table');

        let toggle_columns = [];
        let column_name = ['id','timestamp','user','ip','eventName','target','param','message'];

        for(let i=0;i<8;i++){
            let id = "column" + i;

            toggle_columns.push(document.getElementById(id).checked);
        }
        

        for(let i=0;i<8;i++){
            if(toggle_columns[i] == true){
                $table.bootstrapTable('showColumn', column_name[i]);
            } else{
                $table.bootstrapTable('hideColumn', column_name[i]);
            }
        }
        
        
    }
    
</script>

</body>

</html>


<!-- The Modal -->
<div class="modal fade" id="myModal">
    <div class="modal-dialog">
      <div class="modal-content">
  
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">Advanced Search</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
  
        <!-- Modal body -->
        <div id="myModal-body" class="modal-body">
   
        </div>
  
        <!-- Modal footer -->
        <div class="modal-footer">
   
          <button type="button" class="btn btn-danger" data-dismiss="modal" onclick="modal_apply_click();">Apply</button>
        </div>
  
      </div>
    </div>
  </div>

  
<!-- The Modal -->
<div class="modal fade" id="myModal2">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
  
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">Custom Columns</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
  
        <!-- Modal body -->
        <div id="myModal2-body" class="modal-body">
            <div class="form-check-inline">
                <label class="form-check-label">
                  <input id="column0" type="checkbox" class="form-check-input" value="" checked="true">id
                </label>
              </div>
            <div class="form-check-inline">
                <label class="form-check-label">
                  <input id="column1" type="checkbox" class="form-check-input" value="" checked="true">timestamp
                </label>
              </div>
              <div class="form-check-inline">
                <label class="form-check-label">
                  <input id="column2" type="checkbox" class="form-check-input" value="" checked="true">user
                </label>
              </div>
              <div class="form-check-inline">
                <label class="form-check-label">
                  <input id="column3" type="checkbox" class="form-check-input" value="" checked="true">IP
                </label>
              </div>
              <div class="form-check-inline">
                <label class="form-check-label">
                  <input id="column4" type="checkbox" class="form-check-input" value="" checked="true">Event Name
                </label>
              </div>
              <div class="form-check-inline">
                <label class="form-check-label">
                  <input id="column5" type="checkbox" class="form-check-input" value="" checked="true">Target
                </label>
              </div>
              <div class="form-check-inline">
                <label class="form-check-label">
                  <input id="column6" type="checkbox" class="form-check-input" value="" checked="true">Parameters
                </label>
              </div>
              <div class="form-check-inline">
                <label class="form-check-label">
                  <input id="column7" type="checkbox" class="form-check-input" value="" >Message
                </label>
              </div>
        </div>
  
        <!-- Modal footer -->
        <div class="modal-footer">
   
          <button type="button" class="btn btn-danger" data-dismiss="modal" onclick="modal2_apply_click();">Apply</button>
        </div>
  
      </div>
    </div>
  </div>